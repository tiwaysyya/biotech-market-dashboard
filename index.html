      unmetNeed: 9.0,
      pricingPower: 3.5,
      dealActivity: 4.0,
      investorMomentum: 3.0,
      recommendation: "avoid",

      timeToMarket: 8.0,
      probSuccess: 0.10,
      clinicalRisk: 8.0,
      phaseCost: 5.0,
      cashNeed: 7.0,

      rationaleShort: "High unmet need but commercial model remains broken without pull incentives.",
      personaNotes: {
        founder: "Only viable with innovative reimbursement or nontraditional partnerships.",
        investor: "Impact-focused rather than return-driven.",
        bigpharma: "Low appetite except for stewardship or policy-driven partnerships.",
        consulting: "Policy, incentive design and market shaping are common work here."
      }
    }
  ];

  // ----------------------------
  // KPI calculations
  // ----------------------------
  function computeKpis(list) {
    let tam = 0, weightedCagr = 0, weight = 0, highConviction = 0;

    list.forEach(a => {
      tam += a.tamUSD;
      weightedCagr += a.cagr * a.tamUSD;
      weight += a.tamUSD;
      if (["enter","partner"].includes(a.recommendation)) highConviction++;
    });

    return {
      tam,
      cagr: weightedCagr / Math.max(1, weight),
      highConviction
    };
  }

  // ----------------------------
  // Attractiveness score
  // ----------------------------
  function computeAttractiveness(a) {
    const growth = Math.min(a.cagr / 3, 10);
    const tam = Math.min(a.tamUSD / 12, 10);
    const competitionPenalty = 10 - a.competition * 0.7;

    return Math.max(2, Math.min(10,
      growth*0.2 +
      tam*0.2 +
      competitionPenalty*0.15 +
      a.unmetNeed*0.2 +
      a.investorMomentum*0.25
    ));
  }

  // ----------------------------
  // Feasibility (Equity Research Model)
  // ----------------------------
  function computeFeasibility(a) {
    const success = a.probSuccess * 10;
    const timeScore = Math.max(0, Math.min(10, 10 - (a.timeToMarket - 3) * 1.3));
    const risk = 10 - a.clinicalRisk;
    const cost = 10 - a.phaseCost;
    const cash = 10 - a.cashNeed;

    return Math.max(1.5, Math.min(9.5,
      success*0.3 +
      timeScore*0.2 +
      risk*0.2 +
      cost*0.15 +
      cash*0.15
    ));
  }

  // ----------------------------
  // Filter state
  // ----------------------------
  let activePlay = "all";
  let activeModality = "all";
  let activePersona = "founder";
  let activeArea = null;

  function applyFilters() {
    return areas.filter(a => {
      if (activePlay !== "all" && a.recommendation !== activePlay) return false;
      if (activeModality !== "all" && !a.modalities.includes(activeModality)) return false;
      return true;
    });
  }

  // ----------------------------
  // Render KPIs
  // ----------------------------
  function renderKpis(list) {
    const k = computeKpis(list);

    document.getElementById("kpiGrid").innerHTML = `
      <div class="kpi-card">
        <div class="kpi-label">Total addressable market</div>
        <div class="kpi-value">$${k.tam}B+</div>
        <div class="kpi-sub">Summed across segments</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Weighted TAM growth</div>
        <div class="kpi-value">${k.cagr.toFixed(1)}% CAGR</div>
        <div class="kpi-sub">Segment weighted</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">High conviction</div>
        <div class="kpi-value">${k.highConviction} areas</div>
        <div class="kpi-sub">Enter/partner</div>
      </div>
    `;
  }

  // ----------------------------
  // Render list of areas
  // ----------------------------
  function renderAreaList(list) {
    const box = document.getElementById("areaList");
    document.getElementById("resultsSummary").textContent = `${list.length} areas shown`;
    box.innerHTML = "";

    list.forEach(a => {
      const attract = computeAttractiveness(a);

      const card = document.createElement("div");
      card.className = "area-card";
      if (a.id === activeArea) card.classList.add("active");

      card.innerHTML = `
        <div>
          <div class="area-name">${a.name}</div>
          <div class="area-tags">
            <span class="chip">${a.segment}</span>
            <span class="chip chip-${a.recommendation}">${recommendLabel(a.recommendation)}</span>
          </div>
        </div>

        <div class="area-metrics">
          TAM ~ $${a.tamUSD}B
          <br>Growth ~ ${a.cagr}% CAGR
          <br>Trials ~ ${a.trials}+
        </div>

        <div class="area-score">
          <div class="score-value">${attract.toFixed(1)}/10</div>
          <div class="score-bar">
            <div class="score-bar-inner" style="width:${attract * 10}%"></div>
          </div>
        </div>
      `;

      card.onclick = () => {
        activeArea = a.id;
        renderAll();
      };

      box.appendChild(card);
    });
  }

  function recommendLabel(r) {
    if (r === "enter") return "Enter";
    if (r === "partner") return "Partner";
    if (r === "watch") return "Watch closely";
    if (r === "avoid") return "Avoid";
  }

  // ----------------------------
  // Detail panel
  // ----------------------------
  function renderDetail(area) {
    if (!area) {
      document.getElementById("detailPanel").innerHTML =
        "<div class='detail-sub'>Select a therapeutic area to view details.</div>";
      return;
    }

    const feas = computeFeasibility(area);

    document.getElementById("detailPanel").innerHTML = `
      <div class="detail-title">${area.name}</div>
      <div class="detail-sub">${area.rationaleShort}</div>

      <div class="badge-row">
        <span class="chip">${area.segment}</span>
        <span class="chip">Modalities: ${area.modalities.join(", ")}</span>
        <span class="chip chip-${area.recommendation}">${recommendLabel(area.recommendation)}</span>
      </div>

      <div class="detail-label">Market context</div>
      <div class="detail-body">
        TAM ~ $${area.tamUSD}B, ${area.cagr}% CAGR,
        ${area.trials}+ trials, competition score ${area.competition}/10.
      </div>

      <div class="detail-label">Strategic angle</div>
      <div class="detail-body">${area.personaNotes[activePersona]}</div>

      <div class="detail-label">Feasibility score (equity lens)</div>
      <div class="detail-body">${feas.toFixed(1)}/10</div>

      <div class="detail-label">Key drivers</div>
      <div class="mini-chart">
        ${miniBar("Unmet need", area.unmetNeed)}
        ${miniBar("Pricing power", area.pricingPower)}
        ${miniBar("Deal activity", area.dealActivity)}
        ${miniBar("Investor momentum", area.investorMomentum)}
      </div>
    `;
  }

  function miniBar(label, value) {
    return `
      <div class="mini-bar-row">
        <div class="mini-bar-label">${label}</div>
        <div class="mini-bar-track">
          <div class="mini-bar-fill" style="width:${value * 10}%"></div>
        </div>
        <div style="width:42px; font-size:12px; text-align:right; color:#4b5563;">
          ${value.toFixed(1)}
        </div>
      </div>
    `;
  }

  // ----------------------------
  // Quadrant
  // ----------------------------
  function renderQuadrant(list) {
    const box = document.getElementById("quadrantInner");
    box.innerHTML = "";

    list.forEach(a => {
      const attract = computeAttractiveness(a);
      const feas = computeFeasibility(a);

      const dot = document.createElement("div");
      dot.className = `quadrant-point quad-${a.recommendation}`;
      dot.style.left = `${(feas / 10) * 100}%`;
      dot.style.top = `${100 - (attract / 10) * 100}%`;

      dot.title = `${a.name}\nAttractiveness: ${attract.toFixed(1)}\nFeasibility: ${feas.toFixed(1)}`;

      dot.onclick = () => {
        activeArea = a.id;
        renderAll();
      };

      box.appendChild(dot);
    });
  }

  // ----------------------------
  // Risk chart
  // ----------------------------
  function renderRiskChart(list) {
    const c = document.getElementById("riskChart");
    c.innerHTML = "";

    if (!list.length) {
      c.textContent = "No areas selected.";
      return;
    }

    const avgProb = list.reduce((s, a) => s + a.probSuccess, 0) / list.length;
    const avgTime = list.reduce((s, a) => s + a.timeToMarket, 0) / list.length;
    const avgRisk = list.reduce((s, a) => s + a.clinicalRisk, 0) / list.length;

    const rows = [
      {
        label: "Avg probability of success",
        value: avgProb * 100,
        max: 100,
        display: avgProb * 100,
        unit: "%"
      },
      {
        label: "Avg time to market",
        value: avgTime,
        max: 10,
        display: avgTime,
        unit: "yrs"
      },
      {
        label: "Avg clinical risk",
        value: avgRisk,
        max: 10,
        display: avgRisk,
        unit: "/10"
      }
    ];

    rows.forEach(r => {
      const row = document.createElement("div");
      row.className = "mini-bar-row";

      const label = document.createElement("div");
      label.className = "mini-bar-label";
      label.textContent = r.label;

      const track = document.createElement("div");
      track.className = "mini-bar-track";

      const fill = document.createElement("div");
      fill.className = "mini-bar-fill";
      fill.style.width = Math.max(8, Math.min(100, (r.value / r.max) * 100)) + "%";
      track.appendChild(fill);

      const val = document.createElement("div");
      val.style.width = "50px";
      val.style.textAlign = "right";
      val.style.fontSize = "12px";
      val.style.color = "#4b5563";
      val.textContent =
        r.unit === "%"
          ? r.display.toFixed(0) + "%"
          : r.display.toFixed(1) + " " + r.unit;

      row.appendChild(label);
      row.appendChild(track);
      row.appendChild(val);

      c.appendChild(row);
    });
  }

  // ----------------------------
  // Event handlers
  // ----------------------------
  document.getElementById("playFilterRow").onclick = e => {
    if (e.target.tagName !== "BUTTON") return;
    document.querySelectorAll("#playFilterRow button").forEach(b => b.classList.remove("active"));
    e.target.classList.add("active");
    activePlay = e.target.dataset.play;
    renderAll();
  };

  document.getElementById("modalityFilterRow").onclick = e => {
    if (e.target.tagName !== "BUTTON") return;
    document.querySelectorAll("#modalityFilterRow button").forEach(b => b.classList.remove("active"));
    e.target.classList.add("active");
    activeModality = e.target.dataset.modality;
    renderAll();
  };

  document.getElementById("personaSelect").onchange = e => {
    activePersona = e.target.value;
    renderAll();
  };

  // ----------------------------
  // Render everything
  // ----------------------------
  function renderAll() {
    const filtered = applyFilters();
    renderKpis(filtered);
    renderAreaList(filtered);
    renderDetail(areas.find(a => a.id === activeArea));
    renderQuadrant(filtered);
    renderRiskChart(filtered);
  }

  renderAll();
</script>

</body>
</html>

